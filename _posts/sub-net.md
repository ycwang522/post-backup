##  划分子网和构造超网

### 划分子网

一个拥有许多物理网络的单位，可将所属的物理网络划分为若干个子网。

划分子网的方法是：从网络的主机号借用若干位作为子网号subnet-ID，当然主机号也就相应少了同样的位数。
于是两级IP地址在本单位内部就变为三级IP地址、`网络号、子网号和主机号。`

也可以用以下记法来表示：

	IP地址::={<网络号>,<子网号>,<主机号>}


划分子网后IP地址由原来的两级结构变成了三级结构。
划分子网只是把IP地址的主机号host-ID这部分进行再划分，而不改变IP地址 原来的网络号net-ID.

**子网掩码：**

子网掩码中的1对应于IP地址中原来的net-ID加上subnet-ID，而子网掩码中的0对应于现在的host-ID。
下图d表示R1把子网掩码和收到的数据报的目的IP地址145.13.3.10逐位相`与`，得出了所要找的子网的网络地址。
如下表所示：

![](https://ituku.tk/di/T2YGG/-.png)
<center>**图1.IP地址的各字段和子网掩码**</center>

对于不区分子网时使用子网掩码的说明：为了更便于查找路由表。

如果一个网络不划分子网，该网络使用的子网掩码为默认子网掩码。
**默认子网掩码中1的位置和IP地址中的net-ID正好相对应。**
若是采用默认子网掩码和某个不划分子网的IP地址逐位想与，能够得出该IP地址的网络地址。不用查该地址类别位便可知道是哪一类的IP地址。

> A类地址的默认子网掩码是255.0.0.0
> B类地址的默认子网掩码是255.255.0.0
> C类地址的默认子网掩码是255.255.255.0

**子网掩码是一个网络或一个子网的重要属性。**




### 使用子网时分组的转发

在划分子网后，路由表包含以下三项信息：**目的网络地址，子网掩码和下一条地址。**

分组转发算法：
- 从收到的数据报首部提取目的IP地址D
- 判断是否直接交付。
	- 用各网络的子网掩码和D逐位相“与”，看结果是否和相应的网络地址匹配。
	- 如果匹配，则直接交付（当然还需把D转换成物理地址，把数据报封装成帧发送出去。）
	- 否则就是间接交付。
- 如果路由表中有目的地址为D的特定主机路由，则将数据报传送给路由表中所指明的下一跳路由器；如果没有，执行下一步。
- 对路由表中的每一行（包含目的网络地址、子网掩码、下一跳地址等信息），用其中的子网掩码和D逐位相“与”，其结果为N。
	- 若N与该行的目的网络地址匹配，则将数据报传输给指明的下一跳路由器，否则执行下一步。
- 若路由器表中有一个默认路由，则将数据报传送给路由表中所指明的默认路由器；否则执行下一步。
- 报告转发分组出错。

总结成：
> 1.将本子网的子网掩码和目的地址的IP相与，得到网络地址。看是否在同一个子网络上。如果不在，则将分组交给源主机（发送主机）的默认路由器上，由该默认路由器转发。
2.默认路由收到分组之后，看这一行的网络地址和收到的分组的网络地址是否匹配。使用这一行的子网掩码和收到的分组的目的地址相与，得出的网络地址和给出的网络地址进行比较，看是否一致。
3.继续看下一行，用下一行的子网掩码和目的地址相“与”，如果得到的结果和路由表的网络地址相匹配，则苏红名该网络就是收到的分组所要寻找的目的网络


### 无分类编址CIDA（构造超网）


#### CIDA构成
无分类域间路由选择CIDR。
CIDR的特点有两个：
- 消除了传统的A、B和C类地址以及划分子网的概念，因而可以更加有效地分配IPv4的地址空间。
	- CIDR将32位的地址空间划分为两个部分：
	- 前面的部分是“**网络前缀（前缀）**”，用来指明网络。
	- 后面的部分则用来指明主机
	- 这样一来，CIDR使IP地址从三级编码又回到了两级编码，但这已是无分类的两级编码。记法为：IP地址::={<网络前缀>，<主机号>}
	- CIDR还是用“斜线记法”，即在IP地址后面加上斜线“/”，然后写上网络前缀所占的位数。
	- 例如：128.14.35.7/20，表示网络前缀占了20位。
- CIDR将网络前缀都相同的连续IP地址组成一个**CIDR地址块**

例如，

	128.14.35.7/20
化成二进制表示方式：
128.14.35.7/20=**10000000 00001110 0010**0011 00000111
该地址所在的地址中的最小地址和最大地址可以很方便的得出。

最小地址： 128.14.32.0 **10000000 00001110 0010**0000 00000000
最大地址：128.14.47.255 **10000000 00001110 0010**1111 11111111

一般可以使用地址块中的最小地址和网络前缀的位数表示这个地址块，例如上面的地址块可记为128.14.32.0/20.
在不需要地址块的起始地址时，也可把这样的地址块简称为“/20地址块。”

**CIDA的子网掩码**
1的个数就是网络前缀的长度。
斜线记法中，斜线后面的数字就是地址掩码中的1的个数。

CIDA中有许多地址，在路由表中利用CIDA地址块来查找目的网络，这种地址的聚合常称为**路由聚合。**

#### 最长前缀匹配

CIDR模式下路由表中的项目：**网络前缀+下一跳地址**

匹配时，选择前缀最长的网络前缀的路由。这叫做**最长前缀匹配**，是因为前缀越长，地址块越小，因而路由就越具体。最长前缀又称为**最长匹配或最佳匹配。**